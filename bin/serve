#!/usr/bin/env bash
#
# Custom command to clobber assets, precompile, and start the Rails server
#

set -euo pipefail

# Ensure we're in a Rails directory
if [[ ! -f "bin/rails" ]]; then
  echo "Error: Not in a Rails application directory" >&2
  exit 1
fi

# Kill any existing Rails servers
kill_rails_servers() {
  local killed=false
  local pid_file="tmp/pids/server.pid"
  
  # If PID file exists, try to kill that process
  if [[ -f "$pid_file" ]]; then
    local pid
    pid=$(cat "$pid_file" 2>/dev/null || echo "")
    if [[ -n "$pid" ]] && kill -0 "$pid" 2>/dev/null; then
      echo "Killing Rails server (PID: $pid)"
      kill "$pid" 2>/dev/null || true
      killed=true
      # Wait a bit for graceful shutdown
      sleep 2
      # Force kill if still running
      if kill -0 "$pid" 2>/dev/null; then
        kill -9 "$pid" 2>/dev/null || true
      fi
    fi
    # Remove PID file regardless
    rm -f "$pid_file"
  fi
  
  # Kill processes matching Rails server patterns
  if pkill -f "bin/rails server" 2>/dev/null; then
    killed=true
  fi
  
  # Also kill Puma processes (Rails default server)
  if pkill -f "puma.*rails" 2>/dev/null; then
    killed=true
  fi
  
  if [[ "$killed" == true ]]; then
    echo "Cleaned up existing Rails server(s)"
    # Give processes a moment to clean up
    sleep 1
  fi
}

echo "== Stopping any existing Rails servers =="
kill_rails_servers

echo ""
echo "== Clobbering assets =="
bin/rails assets:clobber

echo ""
echo "== Precompiling assets =="
bin/rails assets:precompile

# Parse arguments for background flag and port
background=false
port=3000
rails_args=()
prev_arg=""

for arg in "$@"; do
  case "$arg" in
    -b|--background)
      background=true
      ;;
    -p|--port)
      prev_arg="$arg"
      ;;
    --port=*)
      port="${arg#*=}"
      rails_args+=("$arg")
      ;;
    *)
      if [[ "$prev_arg" == "-p" ]] || [[ "$prev_arg" == "--port" ]]; then
        port="$arg"
        rails_args+=("$prev_arg" "$arg")
        prev_arg=""
      else
        rails_args+=("$arg")
      fi
      ;;
  esac
done

echo ""
if [[ "$background" == true ]]; then
  echo "== Starting Rails server in background =="
  mkdir -p log
  bin/rails server "${rails_args[@]}" > log/server.log 2>&1 &
  server_pid=$!
  # Wait a moment for server to start
  sleep 2
  echo "Rails server started in background (PID: $server_pid)"
  echo "Logs: tail -f log/server.log"
  echo "Stop server: kill $server_pid"
  echo ""
  echo "Server running at: http://localhost:$port"
else
  echo "== Starting Rails server =="
  echo "Server will be available at: http://localhost:$port"
  echo ""
  exec bin/rails server "${rails_args[@]}"
fi

