name: Keep Supabase Alive

on:
  schedule:
    # Run every 2 days to keep Supabase free tier database alive (pauses after 1 week of inactivity)
    - cron: "0 12 */2 * *" # Every 2 days at 12:00 PM UTC
  workflow_dispatch: # Allow manual triggering

jobs:
  ping-supabase:
    name: Ping Supabase REST API
    runs-on: ubuntu-latest
    steps:
      - name: Ping Supabase REST API
        run: |
          # Determine which secrets to use
          SUPABASE_URL=""
          SUPABASE_KEY=""

          if [ -n "${{ secrets.SUPABASE_URL }}" ] && [ -n "${{ secrets.SUPABASE_ANON_KEY }}" ]; then
            echo "‚úÖ Using SUPABASE_URL and SUPABASE_ANON_KEY secrets"
            SUPABASE_URL="${{ secrets.SUPABASE_URL }}"
            SUPABASE_KEY="${{ secrets.SUPABASE_ANON_KEY }}"
          elif [ -n "${{ secrets.SUPABASE_URL }}" ] && [ -n "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
            echo "‚úÖ Using SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY secrets"
            SUPABASE_URL="${{ secrets.SUPABASE_URL }}"
            SUPABASE_KEY="${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}"
          else
            echo "‚ùå Required secrets not found!"
            echo "Please set the following secrets in GitHub:"
            echo "  - SUPABASE_URL: Your Supabase project URL (e.g., https://xxxxx.supabase.co)"
            echo "  - SUPABASE_ANON_KEY: Your Supabase anon/public key (preferred)"
            echo "    OR"
            echo "  - SUPABASE_SERVICE_ROLE_KEY: Your Supabase service role key (alternative)"
            echo ""
            echo "üí° Find these in Supabase Dashboard > Settings > API"
            echo "   - Project URL: Settings > API > Project URL"
            echo "   - Anon key: Settings > API > Project API keys > anon public"
            exit 1
          fi

          # Ensure URL doesn't have trailing slash
          SUPABASE_URL=$(echo "$SUPABASE_URL" | sed 's|/$||')

          echo "üîÑ Making REST API call to Supabase to register activity..."
          echo "üìç URL: ${SUPABASE_URL}/rest/v1/"

          # Make a simple REST API request to Supabase
          # Querying any endpoint counts as API activity, even if the table doesn't exist
          # Using a generic table name - API request will be logged even if table doesn't exist (404 response)
          # This will register as API activity regardless of the response code (200, 404, etc.)
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X GET \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            "${SUPABASE_URL}/rest/v1/keep_alive?select=*&limit=1" 2>&1)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          # Check if request was successful (200, 404, or 406 are all valid - they indicate API activity)
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 500 ]; then
            echo "‚úÖ Successfully made REST API call to Supabase"
            echo "‚úÖ HTTP Status: ${HTTP_CODE}"
            echo "‚úÖ API activity registered - this should prevent auto-pausing"
            echo ""
            echo "üìä Response preview:"
            echo "$BODY" | head -c 200
            echo ""
            echo ""
            echo "üí° This REST API call is recognized by Supabase as activity."
            echo "üí° Check your Supabase Dashboard > Logs > API to verify the request appears."
          else
            echo "‚ùå Failed to make REST API call to Supabase"
            echo "‚ùå HTTP Status: ${HTTP_CODE}"
            echo "‚ùå Response:"
            echo "$BODY"
            echo ""
            echo "üí° Please verify:"
            echo "   1. SUPABASE_URL is correct (format: https://xxxxx.supabase.co)"
            echo "   2. API key is valid and has proper permissions"
            echo "   3. Project is not paused"
            exit 1
          fi
