name: Keep Supabase Alive

on:
  schedule:
    # Run every 2 days to keep Supabase free tier database alive (pauses after 1 week of inactivity)
    - cron: "0 12 */2 * *" # Every 2 days at 12:00 PM UTC
  workflow_dispatch: # Allow manual triggering

jobs:
  ping-supabase:
    name: Connect to Supabase Database
    runs-on: ubuntu-latest
    steps:
      - name: Install PostgreSQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Connect to Supabase Database
        run: |
          # Determine which connection string to use
          # Priority: Pooler URL (IPv4-compatible) > Regular Database URL (convert to pooler)
          DB_URL=""
          USE_POOLER=false

          if [ -n "${{ secrets.SUPABASE_POOLER_URL }}" ]; then
            echo "âœ… Using SUPABASE_POOLER_URL secret (Session Pooler - IPv4 compatible)"
            DB_URL="${{ secrets.SUPABASE_POOLER_URL }}"
            USE_POOLER=true
          elif [ -n "${{ secrets.DATABASE_URL }}" ]; then
            echo "âš ï¸  Using DATABASE_URL - attempting to convert to Session Pooler for IPv4 compatibility"
            DB_URL="${{ secrets.DATABASE_URL }}"
          elif [ -n "${{ secrets.SUPABASE_DATABASE_URL }}" ]; then
            echo "âš ï¸  Using SUPABASE_DATABASE_URL - attempting to convert to Session Pooler for IPv4 compatibility"
            DB_URL="${{ secrets.SUPABASE_DATABASE_URL }}"
          else
            echo "âŒ No database connection secrets found!"
            echo "Please set one of the following secrets:"
            echo "  - SUPABASE_POOLER_URL (preferred): Session Pooler connection string (IPv4 compatible)"
            echo "    Format: postgresql://user:password@aws-0-region.pooler.supabase.com:6543/database"
            echo "    Find this in Supabase Dashboard > Settings > Database > Connection Pooling > Session mode"
            echo "  - DATABASE_URL or SUPABASE_DATABASE_URL: Will be converted to use pooler (port 6543)"
            exit 1
          fi

          # If not already using pooler, convert connection string to use Session Pooler (port 6543)
          if [ "$USE_POOLER" = "false" ]; then
            echo "ðŸ”„ Converting connection string to use Session Pooler (IPv4 compatible)..."
            # Extract components from connection string
            DB_USER=$(echo "$DB_URL" | sed -n 's|postgresql://\([^:]*\):.*|\1|p')
            DB_PASS=$(echo "$DB_URL" | sed -n 's|postgresql://[^:]*:\([^@]*\)@.*|\1|p')
            DB_HOST=$(echo "$DB_URL" | sed -n 's|.*@\([^:]*\):.*|\1|p')
            DB_NAME=$(echo "$DB_URL" | sed -n 's|.*/\([^?]*\).*|\1|p')
            
            # Convert host to pooler format (replace direct host with pooler host)
            # Direct: db.xxxxx.supabase.co -> Pooler: aws-0-<region>.pooler.supabase.com
            # For now, we'll change port to 6543 and replace host pattern
            POOLER_HOST=$(echo "$DB_HOST" | sed 's/db\.\([^.]*\)\.supabase\.co/aws-0-\1.pooler.supabase.com/')
            
            # If conversion didn't work, try alternative format
            if [ "$POOLER_HOST" = "$DB_HOST" ]; then
              # Try aws-0-<region> format if host is already in that format
              POOLER_HOST=$(echo "$DB_HOST" | sed 's/\.supabase\.co/.pooler.supabase.com/')
              # If still no match, use original host (might already be pooler)
              if [ "$POOLER_HOST" = "$DB_HOST" ]; then
                POOLER_HOST="$DB_HOST"
              fi
            fi
            
            # Construct pooler connection string with port 6543
            DB_URL="postgresql://${DB_USER}:${DB_PASS}@${POOLER_HOST}:6543/${DB_NAME}?sslmode=require"
            echo "âœ… Converted to pooler connection: ${POOLER_HOST}:6543"
          fi

          echo "ðŸ”„ Connecting to Supabase PostgreSQL database via Session Pooler..."

          # Execute a simple query to establish database connection
          # This registers as actual database activity, not just REST API calls
          if psql "$DB_URL" -c "SELECT 1 as keep_alive, NOW() as timestamp;" -t; then
            echo "âœ… Successfully connected to Supabase database and executed query"
            echo "âœ… Database activity registered - this should prevent auto-pausing"
          else
            echo "âŒ Failed to connect to Supabase database"
            echo "âŒ Please verify your connection string is correct and database is accessible"
            echo "ðŸ’¡ Tip: Get the Session Pooler connection string from Supabase Dashboard > Settings > Database > Connection Pooling > Session mode"
            exit 1
          fi
