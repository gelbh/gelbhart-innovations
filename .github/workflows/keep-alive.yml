name: Keep Supabase Alive

on:
  schedule:
    # Run daily to keep Supabase free tier database alive (pauses after 7 days of inactivity)
    - cron: "0 12 * * *" # Daily at 12:00 PM UTC
  workflow_dispatch: # Allow manual triggering

jobs:
  keep-alive:
    name: Keep Supabase Database Active
    runs-on: ubuntu-latest
    steps:
      - name: Keep Supabase Active via Database Operations
        run: |
          # This workflow uses database INSERT/DELETE operations to keep Supabase active.
          #
          # Documentation:
          # - Supabase Dashboard: https://supabase.com/dashboard
          # - API Logs: Supabase Dashboard > Logs > API
          # - Table Editor: Supabase Dashboard > Table Editor > keep_alive

          # Determine which secrets to use
          SUPABASE_URL=""
          SUPABASE_KEY=""

          if [ -n "${{ secrets.SUPABASE_URL }}" ] && [ -n "${{ secrets.SUPABASE_ANON_KEY }}" ]; then
            echo "âœ… Using SUPABASE_URL and SUPABASE_ANON_KEY secrets"
            SUPABASE_URL="${{ secrets.SUPABASE_URL }}"
            SUPABASE_KEY="${{ secrets.SUPABASE_ANON_KEY }}"
          elif [ -n "${{ secrets.SUPABASE_URL }}" ] && [ -n "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
            echo "âœ… Using SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY secrets"
            SUPABASE_URL="${{ secrets.SUPABASE_URL }}"
            SUPABASE_KEY="${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}"
          else
            echo "âŒ Required secrets not found!"
            echo "Please set the following secrets in GitHub:"
            echo "  - SUPABASE_URL: Your Supabase project URL (e.g., https://xxxxx.supabase.co)"
            echo "  - SUPABASE_ANON_KEY: Your Supabase anon/public key (preferred)"
            echo "    OR"
            echo "  - SUPABASE_SERVICE_ROLE_KEY: Your Supabase service role key (alternative)"
            echo ""
            echo "ðŸ’¡ Find these in Supabase Dashboard > Settings > API"
            echo "   - Project URL: Settings > API > Project URL"
            echo "   - Anon key: Settings > API > Project API keys > anon public"
            exit 1
          fi

          # Ensure URL doesn't have trailing slash
          SUPABASE_URL=$(echo "$SUPABASE_URL" | sed 's|/$||')

          echo "ðŸ”„ Starting keep-alive operations via database INSERT/DELETE..."
          echo "ðŸ“ Supabase URL: ${SUPABASE_URL}"
          echo ""

          # Step 1: INSERT a record into keep_alive table
          echo "ðŸ“ Step 1: INSERTing record into keep_alive table..."
          INSERT_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d '{}' \
            "${SUPABASE_URL}/rest/v1/keep_alive" 2>&1)

          INSERT_HTTP_CODE=$(echo "$INSERT_RESPONSE" | tail -n1)
          INSERT_BODY=$(echo "$INSERT_RESPONSE" | sed '$d')

          # Check if INSERT was successful (201 Created or 200 OK)
          if [ "$INSERT_HTTP_CODE" -eq 201 ] || [ "$INSERT_HTTP_CODE" -eq 200 ]; then
            echo "âœ… INSERT operation successful (HTTP ${INSERT_HTTP_CODE})"
            
            # Extract inserted ID if returned (some Supabase configs return the ID)
            if [ -n "$INSERT_BODY" ] && echo "$INSERT_BODY" | grep -q '"id"'; then
              INSERTED_ID=$(echo "$INSERT_BODY" | grep -o '"id":[0-9]*' | grep -o '[0-9]*' | head -1)
              echo "   Inserted record ID: ${INSERTED_ID}"
            fi
          else
            echo "âŒ INSERT operation failed!"
            echo "âŒ HTTP Status: ${INSERT_HTTP_CODE}"
            echo "âŒ Response:"
            echo "$INSERT_BODY"
            echo ""
            echo "ðŸ’¡ Troubleshooting:"
            echo "   1. Verify the 'keep_alive' table exists (run migration: bin/rails db:migrate)"
            echo "   2. Check SUPABASE_URL is correct (format: https://xxxxx.supabase.co)"
            echo "   3. Verify API key has proper permissions (anon key should work for public schema)"
            echo "   4. Check if project is paused (unpause in Supabase Dashboard)"
            echo "   5. Verify table name matches exactly: 'keep_alive' (singular, not plural)"
            exit 1
          fi

          echo ""

          # Step 2: DELETE the oldest record(s) from keep_alive table
          echo "ðŸ—‘ï¸  Step 2: DELETing oldest record from keep_alive table..."
          DELETE_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X DELETE \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            "${SUPABASE_URL}/rest/v1/keep_alive?order=created_at.asc&limit=1" 2>&1)

          DELETE_HTTP_CODE=$(echo "$DELETE_RESPONSE" | tail -n1)
          DELETE_BODY=$(echo "$DELETE_RESPONSE" | sed '$d')

          # Check if DELETE was successful (204 No Content or 200 OK)
          if [ "$DELETE_HTTP_CODE" -eq 204 ] || [ "$DELETE_HTTP_CODE" -eq 200 ]; then
            echo "âœ… DELETE operation successful (HTTP ${DELETE_HTTP_CODE})"
          else
            echo "âš ï¸  DELETE operation returned unexpected status: ${DELETE_HTTP_CODE}"
            echo "   Response: ${DELETE_BODY}"
            echo "   Note: This may be okay if no records exist to delete"
          fi

          echo ""
          echo "âœ… Keep-alive operations completed successfully!"
          echo "âœ… Database activity registered - this should prevent auto-pausing"
          echo ""
          echo "ðŸ“Š Verification:"
          echo "   - Check Supabase Dashboard > Logs > API to see INSERT/DELETE requests"
          echo "   - Check Supabase Dashboard > Table Editor > keep_alive to verify operations"
          echo "   - Monitor project status to ensure it doesn't pause"
          echo ""
          echo "ðŸ’¡ This workflow runs daily to maintain activity."
          echo "ðŸ’¡ The keep_alive table should remain mostly empty (records are deleted immediately)."
