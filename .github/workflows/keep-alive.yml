name: Keep Supabase Alive

on:
  schedule:
    # Run every 2 days to keep Supabase free tier database alive (pauses after 1 week of inactivity)
    - cron: "0 12 */2 * *" # Every 2 days at 12:00 PM UTC
  workflow_dispatch: # Allow manual triggering

jobs:
  ping-supabase:
    name: Connect to Supabase Database
    runs-on: ubuntu-latest
    steps:
      - name: Install PostgreSQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Connect to Supabase Database
        run: |
          # Determine which connection string to use
          DB_URL=""

          if [ -n "${{ secrets.DATABASE_URL }}" ]; then
            echo "âœ… Using DATABASE_URL secret"
            DB_URL="${{ secrets.DATABASE_URL }}"
          elif [ -n "${{ secrets.SUPABASE_DATABASE_URL }}" ]; then
            echo "âœ… Using SUPABASE_DATABASE_URL secret"
            DB_URL="${{ secrets.SUPABASE_DATABASE_URL }}"
          else
            echo "âŒ No database connection secrets found!"
            echo "Please set one of the following secrets:"
            echo "  - DATABASE_URL (preferred): Full PostgreSQL connection string"
            echo "    Format: postgresql://user:password@host:port/database"
            echo "  - SUPABASE_DATABASE_URL: PostgreSQL connection string from Supabase dashboard"
            echo ""
            echo "You can find the connection string in Supabase Dashboard > Settings > Database > Connection string"
            exit 1
          fi

          echo "ğŸ”„ Connecting to Supabase PostgreSQL database..."

          # Execute a simple query to establish database connection
          # This registers as actual database activity, not just REST API calls
          if psql "$DB_URL" -c "SELECT 1 as keep_alive, NOW() as timestamp;" -t; then
            echo "âœ… Successfully connected to Supabase database and executed query"
            echo "âœ… Database activity registered - this should prevent auto-pausing"
          else
            echo "âŒ Failed to connect to Supabase database"
            echo "âŒ Please verify your connection string is correct and database is accessible"
            exit 1
          fi
